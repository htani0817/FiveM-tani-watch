<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tani Watch Player</title>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }
        #player-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #player-container > div,
        #player-container > iframe {
            width: 100% !important;
            height: 100% !important;
        }
        .no-signal {
            color: #333;
            font-family: Arial, sans-serif;
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="player-container">
        <div class="no-signal">NO SIGNAL</div>
    </div>

    <script>
        let player = null;
        let playerType = null;
        let currentVolume = 50;

        // YouTubeのURLからビデオIDを抽出
        function getYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        }

        // TwitchのURLからチャンネル/ビデオ情報を抽出
        function getTwitchInfo(url) {
            // ビデオ (VOD)
            let match = url.match(/twitch\.tv\/videos\/(\d+)/);
            if (match) {
                return { type: 'video', id: match[1] };
            }
            
            // クリップ
            match = url.match(/twitch\.tv\/[^\/]+\/clip\/([a-zA-Z0-9_-]+)/);
            if (match) {
                return { type: 'clip', id: match[1] };
            }
            
            // clips.twitch.tv形式
            match = url.match(/clips\.twitch\.tv\/([a-zA-Z0-9_-]+)/);
            if (match) {
                return { type: 'clip', id: match[1] };
            }
            
            // チャンネル（ライブ）
            match = url.match(/twitch\.tv\/([a-zA-Z0-9_]+)\/?$/);
            if (match) {
                return { type: 'channel', id: match[1] };
            }
            
            return null;
        }

        // プレイヤーを破棄
        function destroyPlayer() {
            if (player) {
                try {
                    if (playerType === 'youtube' && player.destroy) {
                        player.destroy();
                    } else if (playerType === 'twitch') {
                        // Twitchプレイヤーは親要素をクリアして破棄
                        document.getElementById('player-container').innerHTML = '';
                    }
                } catch (e) {
                    console.log('Error destroying player:', e);
                }
                player = null;
                playerType = null;
            }
        }

        // 動画を再生
        function playVideo(url) {
            destroyPlayer();
            
            const container = document.getElementById('player-container');
            container.innerHTML = '<div id="player"></div>';
            
            // YouTube
            const youtubeId = getYouTubeId(url);
            if (youtubeId) {
                playerType = 'youtube';
                player = new YT.Player('player', {
                    width: '100%',
                    height: '100%',
                    videoId: youtubeId,
                    playerVars: {
                        autoplay: 1,
                        controls: 1,
                        modestbranding: 1,
                        rel: 0
                    },
                    events: {
                        onReady: function(event) {
                            event.target.setVolume(currentVolume);
                            event.target.playVideo();
                        }
                    }
                });
                return true;
            }
            
            // Twitch
            const twitchInfo = getTwitchInfo(url);
            if (twitchInfo) {
                playerType = 'twitch';
                
                const options = {
                    width: '100%',
                    height: '100%',
                    autoplay: true,
                    muted: false
                };
                
                if (twitchInfo.type === 'channel') {
                    options.channel = twitchInfo.id;
                } else if (twitchInfo.type === 'video') {
                    options.video = twitchInfo.id;
                } else if (twitchInfo.type === 'clip') {
                    // クリップはiframeで埋め込む
                    container.innerHTML = `<iframe 
                        src="https://clips.twitch.tv/embed?clip=${twitchInfo.id}&parent=cfx-nui-tani-watch&autoplay=true" 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        allowfullscreen>
                    </iframe>`;
                    return true;
                }
                
                player = new Twitch.Player('player', options);
                
                player.addEventListener(Twitch.Player.READY, function() {
                    player.setVolume(currentVolume / 100);
                    player.setMuted(false);
                });
                
                return true;
            }
            
            container.innerHTML = '<div class="no-signal">INVALID URL</div>';
            return false;
        }

        // 音量を設定
        function setVolume(volume) {
            currentVolume = volume;
            
            if (!player) return;
            
            try {
                if (playerType === 'youtube' && player.setVolume) {
                    player.setVolume(volume);
                    if (volume > 0) player.unMute();
                } else if (playerType === 'twitch' && player.setVolume) {
                    player.setVolume(volume / 100);
                    if (volume > 0) player.setMuted(false);
                }
            } catch (e) {
                console.log('Error setting volume:', e);
            }
        }

        // 停止
        function stopVideo() {
            destroyPlayer();
            const container = document.getElementById('player-container');
            container.innerHTML = '<div class="no-signal">NO SIGNAL</div>';
        }

        // メッセージを受信
        window.addEventListener('message', function(event) {
            const data = event.data;
            
            if (data.action === 'play') {
                playVideo(data.url);
            } else if (data.action === 'stop') {
                stopVideo();
            } else if (data.action === 'volume') {
                setVolume(data.volume);
            }
        });

        // ページ読み込み完了を通知
        document.addEventListener('DOMContentLoaded', function() {
            // DUIからのpostMessage用
            if (window.invokeNative) {
                console.log('DUI Player Ready');
            }
        });
    </script>
</body>
</html>
